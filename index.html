<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Hello OpenCV.js</title>
</head>

<body>

    <h2>Hello OpenCV.js</h2>
    <p id="status">OpenCV.js is loading...</p>
    <div>
        <video id="videoInput" width="800" height="450" muted controls src="dedek.mp4"></video>

    </div>
    <div>
        <canvas id="canvasOutput" width="1200" height="725"></canvas>
    </div>
    <div>
        <canvas id="canvasBlack" width="800" height="450"></canvas>
    </div>
    <script async src="opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>

    <script>

        const canvas = document.getElementById("canvasOutput");
        const canvasBlack = document.getElementById("canvasBlack");

        const rect = canvas.getBoundingClientRect();



        function onOpenCvReady()
        {
            cv['onRuntimeInitialized'] = () =>
            {
                document.getElementById('status').innerHTML = 'OpenCV.js is ready.';

                let video = document.getElementById('videoInput');
                let cap = new cv.VideoCapture(video);


                let frame = new cv.Mat(video.height, video.width, cv.CV_8UC4);
                let frame_hsv = new cv.Mat(video.height, video.width, cv.CV_8UC4);


                const FPS = 60;

                // schedule the first one.
                setTimeout(processVideo, 0);


                let Hs = [];
                let Ss = [];
                let Vs = [];


                canvas.addEventListener("click", function (event)
                {
                    const x = event.clientX - canvas.offsetLeft + window.pageXOffset;
                    const y = event.clientY - canvas.offsetTop + window.pageYOffset;
                    // const ctx = canvas.getContext("2d");
                    // const pixelData = ctx.getImageData(x, y, 1, 1).data;

                    // console.log("Pixel value at (" + x + ", " + y + "): " + pixelData);

                    let H = frame_hsv.ucharAt(y, x * frame_hsv.channels());
                    let S = frame_hsv.ucharAt(y, x * frame_hsv.channels() + 1);
                    let V = frame_hsv.ucharAt(y, x * frame_hsv.channels() + 2);

                    Hs = Hs.concat(H);
                    Ss = Ss.concat(S);
                    Vs = Vs.concat(V);

                    console.log("Pixel value at (" + x + ", " + y + "): H:" + H + " S:" + S + " V: " + V);
                    console.log(Hs)
                    console.log(Ss)
                    console.log(Vs)

                });

                function processVideo()
                {
                    try
                    {
                        let begin = Date.now();

                        // start processing.
                        cap.read(frame);


                        // select good points
                        // let keypoints = simpleBlobDetector(frame, { faster: true, filterByInertia: false })
                        // for (const keypoint of keypoints)
                        // {
                        //     const center = new cv.Point(keypoint.pt.x, keypoint.pt.y)
                        //     cv.circle(frame, center, keypoint.size, [255, 0, 0, 255], 3)
                        // }
                        cv.cvtColor(frame, frame_hsv, cv.COLOR_RGB2HSV)
                        let low = new cv.Mat(frame_hsv.rows, frame_hsv.cols, frame_hsv.type(), [Math.min(...Hs) - 10, Math.min(...Ss, 100) - 5, Math.min(...Vs, 100) - 5, 0]);
                        let high = new cv.Mat(frame_hsv.rows, frame_hsv.cols, frame_hsv.type(), [Math.max(...Hs) + 10, 255, 255, 255]);



                        // Apply the threshold to each channel of the image
                        const thresholdMat = new cv.Mat();
                        cv.inRange(frame_hsv, low, high, thresholdMat);




                        cv.imshow('canvasOutput', frame);
                        cv.imshow('canvasBlack', thresholdMat);

                        // schedule the next one.
                        let delay = 1000 / FPS - (Date.now() - begin);
                        low.delete();
                        high.delete();
                        thresholdMat.delete();
                        setTimeout(processVideo, delay);
                    } catch (err)
                    {
                        console.error(err);
                    }
                };
            };

        }
    </script>
</body>

</html>